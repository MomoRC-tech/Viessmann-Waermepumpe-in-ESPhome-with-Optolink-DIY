name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate version headers (best-effort)
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME:-}"
          if [ -z "$VERSION" ]; then
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "dev")
          fi
          echo "Autogenerated version: $VERSION"
          for dir in Vitocal_Optolink-esp32C3 Vitocal_Optolink-esp32C3-Bartels Vitocal_Optolink_esp32C3_test; do
            if [ -d "$dir" ]; then
              printf '#ifndef DEVICE_SWVERSION\n#define DEVICE_SWVERSION "%s"\n#endif\n' "$VERSION" > "$dir/version_autogen.h"
            fi
          done

      - name: Install Arduino CLI (latest)
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh -s - latest
          sudo mv bin/arduino-cli /usr/local/bin/arduino-cli
          arduino-cli version

      - name: Configure core
        run: |
          arduino-cli config init --overwrite
          arduino-cli config set library.enable_unsafe_install true
          arduino-cli config set board_manager.additional_urls "https://espressif.github.io/arduino-esp32/package_esp32_index.json"
          arduino-cli core update-index
          arduino-cli core install esp32:esp32

      - name: Install libraries
        run: |
          set -euo pipefail
          arduino-cli lib update-index
          # FastLED no longer used in sketches; omit installation
          # ArduinoHA depends on PubSubClient
          arduino-cli lib install "PubSubClient"
          # ArduinoHA also depends on ArduinoJson
          arduino-cli lib install "ArduinoJson"
          arduino-cli lib install "ElegantOTA"
          arduino-cli lib install "WebSerial"

          # ESP32-C3 (esp32 core v3.x) needs versions of AsyncTCP / ESPAsyncWebServer
          # that are compatible with each other. The Arduino Library Manager combo
          # can currently fail with const-qualifier errors, so we pin to ESP32Async.
          mkdir -p "$HOME/Arduino/libraries"
          rm -rf "$HOME/Arduino/libraries/AsyncTCP"
          rm -rf "$HOME/Arduino/libraries/ESPAsyncWebServer"
          git clone --depth 1 https://github.com/ESP32Async/AsyncTCP.git "$HOME/Arduino/libraries/AsyncTCP"
          git clone --depth 1 https://github.com/ESP32Async/ESPAsyncWebServer.git "$HOME/Arduino/libraries/ESPAsyncWebServer"

          # ArduinoHA not (yet) in official index: clone repo
          rm -rf "$HOME/Arduino/libraries/ArduinoHA"
          git clone --depth 1 https://github.com/dawidchyrzynski/arduino-home-assistant.git "$HOME/Arduino/libraries/ArduinoHA"
          # Correct VitoWiFi repository (previously wrong: openv/vitowifi does not exist)
          rm -rf "$HOME/Arduino/libraries/VitoWiFi"
          git clone --depth 1 https://github.com/bertmelis/VitoWiFi.git "$HOME/Arduino/libraries/VitoWiFi"
          ls -1 "$HOME/Arduino/libraries" || true

      - name: Compile (ESP32-C3 subprojects)
        run: |
          set -euo pipefail
          arduino-cli compile \
            --fqbn esp32:esp32:esp32c3 \
            "Vitocal_Optolink-esp32C3/Vitocal_Optolink-esp32C3.ino"
          arduino-cli compile \
            --fqbn esp32:esp32:esp32c3 \
            "Vitocal_Optolink-esp32C3-Bartels/Vitocal_Optolink-esp32C3-Bartels.ino"
